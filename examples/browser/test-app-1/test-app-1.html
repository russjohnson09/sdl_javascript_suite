<html>

<head>
    <script src='./../../../lib/js/dist/SDL.js'></script>

    <script>

        const SdlSession = SDL.session.WsClientSession;

        const ServiceType = SDL.protocol.enums.ServiceType;
        const RpcRequest = SDL.rpc.RpcRequest;
        const RpcType = SDL.rpc.enums.RpcType;


        class EventEmitter {
            constructor() {
                this.events = {};
            }
            on(event, listener) {
                if (typeof this.events[event] !== 'object') {
                    this.events[event] = [];
                }
                this.events[event].push(listener);
                return () => this.removeListener(event, listener);
            }
            removeListener(event, listener) {
                if (typeof this.events[event] === 'object') {
                    const idx = this.events[event].indexOf(listener);
                    if (idx > -1) {
                        this.events[event].splice(idx, 1);
                    }
                }
            }
            emit(event, ...args) {
                if (typeof this.events[event] === 'object') {
                    this.events[event].forEach(listener => listener.apply(this, args));
                }
            }
            once(event, listener) {
                const remove = this.on(event, (...args) => {
                    remove();
                    listener.apply(this, args);
                });
            }
        };


        class TestApp1 extends EventEmitter {

            constructor() {
                super();
                let appID = (Math.floor(Date.now() / 1000) + '').substr(7);

                this._iconData = "data:image/gif;base64,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";

                let appConfig = {
                    "appName": appID,
                    "appID": appID,
                    "fullAppID": appID,
                    "appHMIType": [
                        "DEFAULT",
                        "MEDIA"
                    ],
                    "hmiDisplayLanguageDesired": "EN-US",
                    "isMediaApplication": false,
                    "languageDesired": "EN-US",
                    "syncMsgVersion": {
                        "majorVersion": 3,
                        "minorVersion": 1,
                        "patchVersion": 0
                    }
                };

                this._eventListeners = [];
                this._appConfig = appConfig;
                let baseTransportConfig = {};
                this._sdlSession = new SdlSession(baseTransportConfig, this);
                this._maxCorrelationId = 0;
            }

            static async startApp() {
                let obj = new this();
                await obj._init();
                return obj;
            }

            async _init() {
                console.log(`init app`);
                await this._startConnection();
                await this._startService();
                await this._registerApp();

                await this._setAppIcon();
            }

            async _fetchImageBase64(path) {
                let img = await fetch(path);
                let blob = await img.blob();
                return blob;
                // return this.blobToBase64(blob);
            }

            async _fetchImageUnit8Array(path) {
                let img = await fetch(path);
                let blob = await img.blob();
                let aryBuffer = await new Response(blob).arrayBuffer();
                return         new Uint8Array(aryBuffer);
            }

            async _setAppIcon() {
                let fileBinary = await this._fetchImageUnit8Array(this._iconData);
                console.log('_setAppIcon',{fileBinary});
                let fileName = this._appConfig.appID + '_icon.gif';
                let fileType = 'GRAPHIC_PNG';

                let putFile = await this.sendRPCJson({
                    method: 'PutFile',
                    params: {
                        syncFileName: fileName,
                        fileType,
                        persistentFile: true,

                    },
                    bulkData: fileBinary //unit8 array

                });

                console.log('_setAppIcon',{putFile});

                let setIconResult = await this.sendRPCJson({
                    method: 'SetAppIcon',
                    params: {
                        syncFileName: fileName,
                    }
                });

                console.log('_setAppIcon',{setIconResult});


            }

            async _registerApp() {
                console.log('_registerApp');
                let result = await this.sendRPCJson(
                    {
                        method: 'RegisterAppInterface',
                        params: this._appConfig,
                    }
                );
                console.log(`app registered response`, { result });
            }

            async sendRPCJson(
                data
            ) {

                let { method, params, bulkData } = data;
                let id = ++this._maxCorrelationId;

                let rpcRequest = new RpcRequest(
                    {
                        functionName: method,
                        parameters: params,
                        rpcType: RpcType.REQUEST,
                    }
                );
                rpcRequest.setCorrelationID(id);

                //bulk data is blob.
                if (bulkData) {
                    rpcRequest.setBulkData(bulkData);
                }


                return await this.sendRPC(rpcRequest);


            }

            async sendRPC(rpcRequest) {

                const self = this;
                return new Promise((resolve) => {
                    console.log(`sendRPC`, rpcRequest);
                    let correlationId = rpcRequest.getCorrelationID();


                    self.on('INCOMING_RPC', (rpcResponse) => {
                        let responseCorrelationId = rpcResponse.getCorrelationID();

                        if (responseCorrelationId === correlationId) {
                            return resolve(rpcResponse);
                        }
                    });

                    self._sdlSession.sendRpc(rpcRequest);

                })
            }

            async _startService() {

                const self = this;
                return new Promise((resolve) => {
                    self.on('onProtocolSessionStarted', () => {
                        console.log('onProtocolSessionStarted connected');
                        return resolve();
                    });

                    self._sdlSession.startService(ServiceType.RPC, 0, false);

                })
            }

            async _startConnection() {
                const self = this;
                return new Promise((resolve) => {
                    self.once('onTransportConnected', () => {
                        console.log('onTransportConnected');
                        return resolve();
                    });
                    self._sdlSession.start();
                })
            }

            async onTransportConnected() {
                console.log(`transport is connected`);
                this.emit('onTransportConnected', {})
            }
            async onProtocolSessionEnded() {
                console.error(`protocol session ended ACK`);
            }
            async onProtocolSessionEndedNACKed() {
                console.error(`protocol session ended NACK`);
            }

            async onProtocolSessionStarted() {
                console.log(`onProtocolSessionStarted`);
                this.emit('onProtocolSessionStarted')
            }

            async onRpcMessageReceived(rpcMessage) {
                console.log(`onRpcMessageReceived`, rpcMessage);

                let functionName = rpcMessage.getFunctionName();
                let parameters = rpcMessage.getParameters();
                this.emit('INCOMING_RPC', rpcMessage);
            }
        }

    </script>


    <script>



        (async function () {
            let app = await TestApp1.startApp();

            console.log('app started and registered', app);


            console.log('start listeners');
            app.on('INCOMING_RPC', async (rpcMessage) => {
                let functionName = rpcMessage.getFunctionName();

                console.log(`INCOMING_RPC`, functionName, rpcMessage);

                if (functionName === 'OnHMIStatus') {
                    let parameters = rpcMessage.getParameters();
                    let {hmiLevel} = parameters;
                    if (hmiLevel === 'FULL') {

                        let rpcResponse = await app.sendRPCJson(
                        {
                            "method": "Show",
                            "params": {
                                "mainField1": "こんにちは",
                                "mainField2": "你好 ( ni hao / nĭ hăo )",
                                "mainField3": "@#$#%$^^%&**&(_     !@#$@#$~~~```"
                            }
                        }
                    );
                    console.log(`show message response`, rpcResponse);
                    }

                }
            });

            // app.on('INCOMING_RPC.OnHMIStatus', (rpcMessage) => {
            //     console.log(`hmi status update`, rpcMessage);
            // });

        })();
    </script>
</head>


<body>

    <img src="./test_icon_1.png" />

</body>

</html>