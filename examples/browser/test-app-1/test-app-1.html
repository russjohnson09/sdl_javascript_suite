<html>

<head>
    <script src='./../../../lib/js/dist/SDL.js'></script>

    <script>

        const SdlSession = SDL.session.WsClientSession;

        const ServiceType = SDL.protocol.enums.ServiceType;
        const RpcRequest = SDL.rpc.RpcRequest;
        const RpcType = SDL.rpc.enums.RpcType;

        class EventEmitter {
            constructor() {
                this.events = {};
            }
            on(event, listener) {
                if (typeof this.events[event] !== 'object') {
                    this.events[event] = [];
                }
                this.events[event].push(listener);
                return () => this.removeListener(event, listener);
            }
            removeListener(event, listener) {
                if (typeof this.events[event] === 'object') {
                    const idx = this.events[event].indexOf(listener);
                    if (idx > -1) {
                        this.events[event].splice(idx, 1);
                    }
                }
            }
            emit(event, ...args) {
                if (typeof this.events[event] === 'object') {
                    this.events[event].forEach(listener => listener.apply(this, args));
                }
            }
            once(event, listener) {
                const remove = this.on(event, (...args) => {
                    remove();
                    listener.apply(this, args);
                });
            }
        };


        class TestApp1 extends EventEmitter {

            constructor() {
                super();
                let appID = (Math.floor(Date.now() / 1000) + '').substr(7);

                let appConfig = {
                    "appName": appID,
                    "appID": appID,
                    "fullAppID": appID,
                    "appHMIType": [
                        "DEFAULT",
                        "MEDIA"
                    ],
                    "hmiDisplayLanguageDesired": "EN-US",
                    "isMediaApplication": false,
                    "languageDesired": "EN-US",
                    "syncMsgVersion": {
                        "majorVersion": 3,
                        "minorVersion": 1,
                        "patchVersion": 0
                    }
                };

                this._eventListeners = [];
                this._appConfig = appConfig;
                let baseTransportConfig = {};
                this._sdlSession = new SdlSession(baseTransportConfig, this);
                this._maxCorrelationId = 0;
            }

            static async startApp() {
                let obj = new this();
                await obj._init();
                return obj;
            }

            async _init() {
                console.log(`init app`);
                await this._startConnection();
                await this._startService();
                await this._registerApp();
            }

            async _registerApp() {
                console.log('_registerApp');
                let result = await this.sendRPCJson(
                    {
                        method: 'RegisterAppInterface',
                        params: this._appConfig,
                    }
                );
                console.log(`app registered response`, { result });
            }

            async sendRPCJson(
                data
            ) {

                let { method, params, bulkData } = data;
                let id = ++this._maxCorrelationId;

                let rpcRequest = new RpcRequest(
                    {
                        functionName: method,
                        parameters: params,
                        rpcType: RpcType.REQUEST,
                    }
                );
                rpcRequest.setCorrelationID(id);

                //bulk data is blob.
                if (bulkData) {
                    rpcRequest.setBulkData(bulkData);
                }


                let result = await this.sendRPC(rpcRequest);

                console.log(`sendRPC result`, result);

                let result2 = {
                    method: result.getFunctionName(),
                    params: result.getParameters(),
                    bulkData: result.getBulkData()
                };

                console.log(`sendRPC result`, result2);

                return result2;


            }

            async sendRPC(rpcRequest) {

                const self = this;
                return new Promise((resolve) => {
                    console.log(`sendRPC`, rpcRequest);
                    let correlationId = rpcRequest.getCorrelationID();


                    self.on('INCOMING_RPC', (rpcResponse) => {
                        let responseCorrelationId = rpcResponse.getCorrelationID();

                        if (responseCorrelationId === correlationId) {
                            return resolve(rpcRequest);
                        }
                    });

                    self._sdlSession.sendRpc(rpcRequest);

                })
            }

            async _startService() {

                const self = this;
                return new Promise((resolve) => {
                    self.on('onProtocolSessionStarted', () => {
                        console.log('onProtocolSessionStarted connected');
                        return resolve();
                    });

                    self._sdlSession.startService(ServiceType.RPC, 0, false);

                })
            }

            async _startConnection() {
                const self = this;
                return new Promise((resolve) => {
                    self.once('onTransportConnected', () => {
                        console.log('onTransportConnected');
                        return resolve();
                    });
                    self._sdlSession.start();
                })
            }

            async onTransportConnected() {
                console.log(`transport is connected`);
                this.emit('onTransportConnected', {})
            }
            async onProtocolSessionEnded() {
                console.error(`protocol session ended ACK`);
            }
            async onProtocolSessionEndedNACKed() {
                console.error(`protocol session ended NACK`);
            }

            async onProtocolSessionStarted() {
                console.log(`onProtocolSessionStarted`);
                this.emit('onProtocolSessionStarted')
            }

            async onRpcMessageReceived(rpcMessage) {
                console.log(`onRpcMessageReceived`, rpcMessage);

                let functionName = rpcMessage.getFunctionName();
                let parameters = rpcMessage.getParameters();
                let eventName = 'INCOMING_RPC';
                this.emit(eventName + '.' + functionName, rpcMessage);
                this.emit(eventName, rpcMessage);
            }
        }

    </script>


    <script>



        (async function () {
            let app = await TestApp1.startApp();

            app.on('INCOMING_RPC.OnHMIStatus', (rpcMessage) => {
                console.log(`hmi status update`, rpcMessage);
            });

        })();
    </script>
</head>


<body>

</body>

</html>